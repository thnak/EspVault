name: QEMU Tests

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'components/**'
      - 'main/**'
      - 'test/qemu/**'
      - '.github/workflows/qemu-tests.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'components/**'
      - 'main/**'
      - 'test/qemu/**'
      - '.github/workflows/qemu-tests.yml'
  workflow_dispatch:

jobs:
  qemu-test:
    name: Run QEMU Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'
      
      - name: Setup ESP-IDF
        uses: espressif/esp-idf-ci-action@v1
        with:
          esp_idf_version: v5.4
          target: esp32
      
      - name: Install QEMU
        run: |
          echo "Installing QEMU for ESP32..."
          $IDF_PATH/install.sh --enable-qemu
      
      - name: Build Test Firmware
        run: |
          cd test/qemu
          . $IDF_PATH/export.sh
          idf.py build
      
      - name: Run QEMU Tests
        run: |
          cd test/qemu
          . $IDF_PATH/export.sh
          timeout 120 idf.py qemu monitor | tee qemu_output.log
        continue-on-error: false
      
      - name: Parse Test Results
        if: always()
        run: |
          cd test/qemu
          if grep -q "All Tests Completed" qemu_output.log; then
            echo "✓ Test suite completed"
            grep -o "[0-9]* Tests [0-9]* Failures [0-9]* Ignored" qemu_output.log | tail -1
            
            FAILURES=$(grep -o "[0-9]* Failures" qemu_output.log | tail -1 | grep -o "[0-9]*")
            if [ "$FAILURES" != "0" ]; then
              echo "✗ $FAILURES test(s) failed"
              exit 1
            fi
            echo "✓ All tests passed"
          else
            echo "✗ Test suite did not complete"
            tail -50 qemu_output.log
            exit 1
          fi
      
      - name: Upload Test Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: qemu-test-logs
          path: test/qemu/qemu_output.log
          retention-days: 7
      
      - name: Upload Build Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: qemu-test-build
          path: |
            test/qemu/build/*.bin
            test/qemu/build/*.elf
            test/qemu/build/*.map
          retention-days: 7
